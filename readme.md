# koishi-plugin-monetary-bourse

[![npm](https://img.shields.io/npm/v/koishi-plugin-monetary-bourse?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-monetary-bourse)

为 Koishi 提供基于 `monetary` 通用货币系统的股票交易所功能。

本插件模拟了一个具备**自动宏观调控**、**丰富日内走势形态**和**资金冻结机制**的拟真股票市场。用户可以使用机器人通用的货币（如信用点）进行股票买卖、炒股理财。

## ✨ 特性

- **📈 拟真 K 线引擎**：
  - 内置 **12 种日内走势形态**（如：早盘冲高回落、V型反转、尾盘拉升、M顶/W底等）。
  - 走势不再是单纯的随机波动，每天自动或随机切换不同的操盘剧本，大幅提升观察乐趣。
  - 结合 **周级波浪** 与 **宏观趋势**，模拟真实市场的多周期叠加效应。
- **📊 精美 K 线与持仓渲染**：使用 Puppeteer 渲染实时/日/周线图和个人持仓信息，Alpha 2 版本优化了坐标轴标签算法，防止文字重叠，观感更佳。
- **❄️ 资金冻结机制**：交易采用 T+0 但资金/股票非即时到账模式，根据金额计算冻结时间，增加博弈深度。
- **🏦 银行联动**：支持与 `koishi-plugin-monetary-bank` 联动，现金不足时自动扣除银行活期存款。
- **🕹️ 宏观调控**：管理员可手动干预股价目标，或强制切换当天的 K 线剧本。

## 更新记录

- **1.1.1（Alpha.4）**：
  - 新增：硬性涨跌幅上限规则（±50%），同时约束日内与周内视角。随机与手动调控的结果均会在应用前进行限幅。
  - 新增：更随机的自动宏观调控——随机刷新宏观目标（约每 6–24 小时），并随机调整周波浪频率与幅度（波浪段数约 5–10、周幅度约 6%–12%）。
  - 修复：手动宏观调控命令更新状态时，严格排除主键字段，避免 `TypeError: cannot modify primary key`。
  - 变更：移除配置项中的手动宏观调控相关字段（`enableManualControl`、`manualTargetPrice`、`manualDuration`），改为仅通过管理员指令进行宏观调控。
  - 新增：开发测试命令方便快速验证逻辑（`bourse.test.price`、`bourse.test.clamp`），默认注释不启用，若需要请手动修改代码打开调试。

- **1.1.0**：
  - Alpha.3版本转为正式版。

- **Alpha.3**：
  - 新增：持仓盈亏计算与持仓成本追踪（`totalCost` 字段），在 `stock.my` 中展示成本价、持仓成本、当前市值、盈亏金额与盈亏百分比。
  - 新增：持仓信息 HTML 渲染（`renderHoldingImage`），使用 Puppeteer 输出美观的持仓卡片图像，包含进行中的挂单列表和盈亏高亮显示。
  - 修复：统一所有金额与价格的显示与存储为保留两位小数，避免浮点精度累积导致的计算偏差（涉及 `currentPrice`、历史记录、支付、扣款、银行活期处理等）。
  - 修复：兼容旧版持仓数据（旧记录没有 `totalCost`）——合并新旧持仓时使用合理估算策略以避免成本被稀释：
    - 若旧持仓无成本记录，新买入时以交易单价对旧持仓进行估算（保证合并后平均成本合理）；
    - 卖出时若无成本记录则使用当前市价估算以避免错误盈亏展示。
  - 修复：当 `maxFreezeTime = 0`（表示无冻结）时，交易将立即完成并触发即时处理（不再长期挂起）。
  - 修复：支付、现金变更及银行活期扣除流程中均使用两位小数保留，避免因浮点运算导致余额不一致。

- **1.0.0**：
  - 修复：解决长期运行时触发的 `TypeError: cannot modify primary key`（更新 `bourse_state` 时排除主键字段，仅按条件写入非主键字段），提高数据库兼容性与稳定性。

- **Alpha.2**：
  - 在 Alpha.1 的基础上，扩展并完善了 K 线引擎，新增 12 种日内走势剧本、周级波浪叠加以及坐标轴标签冲突修复等视觉与体验改进。
  - 该版本引入了更丰富的日内走势（例如早盘冲高回落、V 型反转、尾盘拉升、M 顶/W 底等），并改进了 Puppeteer 渲染逻辑以减少横轴标签重叠。
  - 致命问题说明：长期运行时可能触发 `TypeError: cannot modify primary key`（根因：更新持久化 `bourse_state` 时不小心将主键字段包含在更新负载中，某些数据库实现会拒绝修改主键），该问题在后续修复版本中已处理，请在生产环境中尽量升级至稳定版本。

- **Alpha.1**：
  - 发布基础功能：买卖、资金冻结、挂单、历史行情存储以及 `stock` 家族指令（`stock` / `stock.buy` / `stock.sell` / `stock.my`）。
  - 支持与 `monetary` 与 `monetary-bank` 的基本联动，提供最小可用的股票交易所模拟能力。

## 📦 依赖

本插件需要以下服务：
- `database`: 用于存储持仓、历史行情和挂单记录。
- `puppeteer`: 用于渲染股市行情图。
- `monetary`: (可选) 用于获取用户货币余额（本插件直接操作数据库表，monetary 插件需安装以建立表结构）。

## 🔧 配置项

可以在控制台插件配置页进行设置：

### 基础设置
- **currency**: 货币单位名称（默认：`信用点`）。
- **stockName**: 股票名称（默认：`Koishi股份`）。
- **initialPrice**: 股票初始价格（默认：`1200`）。
- **maxHoldings**: 单人最大持仓限制（默认：`100000`）。

### 交易时间
- **openHour**: 每日开市时间（小时，0-23，默认 `8` 点）。
- **closeHour**: 每日休市时间（小时，0-23，默认 `23` 点）。
- **marketStatus**: 股市总开关，可选 `open` (强制开启)、`close` (强制关闭)、`auto` (自动按时间)。

### 冻结机制
- **freezeCostPerMinute**: 每多少货币金额计为1分钟冻结时间（默认 `100`）。
- **minFreezeTime**: 最小冻结时间（分钟，默认 `10`）。
- **maxFreezeTime**: 最大冻结时间（分钟，默认 `1440` 即24小时）。

### 宏观调控
- 已移除配置项中的手动宏观调控字段；请使用管理员指令进行宏观调控。

## 🎮 指令说明

### 用户指令

- **`stock [interval]`**
  - 查看股市行情。
  - 参数 `interval`: 可选 `day` (日线)、`week` (周线)，不填默认为实时走势（最近100条）。
  - 示例：`stock` (查看实时), `stock day` (查看日线)。

- **`stock.buy <amount>`**
  - 买入股票。
  - 参数 `amount`: 购买股数（整数）。
  - 说明：扣除现金（优先）或银行活期，股票将在冻结时间结束后到账。

- **`stock.sell <amount>`**
  - 卖出股票。
  - 参数 `amount`: 卖出股数（整数）。
  - 说明：扣除持仓，获得的资金将在冻结时间结束后到账。

- **`stock.my`**
  - 查看我的账户。
  - 显示当前持仓、市值以及正在进行中（冻结中）的买卖订单。

### 管理员指令 (权限等级 3)

- **`stock.control <price> [hours]`**
  - 设置宏观调控目标。
  - 说明：强行引导股价在指定时间内向目标价格移动。若目标涨跌超出±50%限幅，会自动调整至限幅边界后再应用。
  - 示例：`stock.control 5000 12` (在12小时内让股价涨/跌到5000)。

- **`stock.pattern`** *(Alpha 2 新增)*
  - 强制切换 K 线模型。
  - 说明：手动随机切换当前使用的日内走势剧本（如从“单边下跌”切换为“尾盘拉升”）。

- **`bourse.admin.market <status>`**
  - 设置股市开关状态。
  - 参数 `status`: `open` (开启), `close` (关闭), `auto` (自动)。
  - 说明：手动开市时会自动重置并切换一个新的日内 K 线形态。

- **`bourse.test.price [ticks]`**
  - 开发测试：推进价格更新若干次并返回当前价格。
  - 参数 `ticks`: 推进次数，默认 1，最大 500。

- **`bourse.test.clamp <percent>`**
  - 开发测试：尝试目标涨跌幅并查看限幅结果。
  - 参数 `percent`: 期望涨跌百分比，例如 `60` 或 `-40`。

## 💡 常见问题

**Q: 为什么买了股票没有立刻到账？**
A: 本插件设计了基于交易金额的动态冻结机制。交易额越大，冻结时间越长（可配置）。请使用 `stock.my` 查看剩余解冻时间。

**Q: 股价是如何波动的？**
A: 股价由四部分叠加而成：
1. **宏观趋势**：根据自动或手动的目标价格计算的线性趋势。
2. **周级波浪**：7天为一个大周期的正弦复合波浪。
3. **日内形态**：每天随机从 12 种剧本中选择多种（如 V 型、倒 V 型、阶梯上涨等）。
4. **随机噪音**：微小的随机波动。

此外，为保证市场稳定性，应用了**涨跌幅硬性限制**：相对于周周期起始价与当日开盘价的双重基准，股价的涨跌幅不得超过 ±50%。当随机或手动设置的目标超出限幅时，将自动截断至限幅边界。
