# koishi-plugin-monetary-bourse

[![npm](https://img.shields.io/npm/v/koishi-plugin-monetary-bourse?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-monetary-bourse)

为 Koishi 提供基于 `monetary` 通用货币系统的股票交易所功能。

本插件模拟了一个具备自动宏观调控、周期性波动和资金冻结机制的简易股票市场。用户可以使用机器人通用的货币（如信用点）进行股票买卖、炒股理财。

## ✨ 特性

- **拟真股市算法**：包含长期趋势、随机波动和周期性波浪算法，模拟真实的股价走势。
- **可视化K线图**：使用 Puppeteer 渲染精美的实时、日线、周线走势图。
- **资金冻结机制**：交易并非即时到账，根据交易金额计算冻结时间，增加博弈乐趣。
- **宏观调控**：管理员可以手动干预股价走势，设定目标价格，系统将平滑过渡到目标价。
- **银行联动**：支持与 `koishi-plugin-monetary-bank` 联动，若现金不足可自动扣除银行活期存款（需安装对应插件）。
- **休市机制**：支持设置每日开市/休市时间，周末自动休市。

## 📦 依赖

本插件需要以下服务：
- `database`: 用于存储持仓、历史行情和挂单记录。
- `puppeteer`: 用于渲染股市行情图。
- `monetary`: (可选) 用于获取用户货币余额，实际上本插件直接操作 `monetary` 数据库表。

## 🔧 配置项

可以在控制台插件配置页进行设置：

### 基础设置
- **currency**: 货币单位名称（默认：`信用点`）。
- **stockName**: 股票名称（默认：`Koishi股份`）。
- **initialPrice**: 股票初始价格（默认：`1200`）。
- **maxHoldings**: 单人最大持仓限制（默认：`100000`）。

### 交易时间
- **openHour**: 每日开市时间（小时，0-23，默认 `8` 点）。
- **closeHour**: 每日休市时间（小时，0-23，默认 `23` 点）。
- **marketStatus**: 股市总开关，可选 `open` (强制开启)、`close` (强制关闭)、`auto` (自动按时间)。

### 冻结机制
为了防止高频刷钱，交易后资金/股票需要冻结一段时间。
- **freezeCostPerMinute**: 每多少货币金额计为1分钟冻结时间（默认 `100`）。
- **minFreezeTime**: 最小冻结时间（分钟，默认 `10`）。
- **maxFreezeTime**: 最大冻结时间（分钟，默认 `1440` 即24小时）。

### 宏观调控
- **enableManualControl**: 是否开启手动强力调控模式（覆盖自动波动）。
- **manualTargetPrice**: 手动模式下的目标价格。
- **manualDuration**: 手动调控周期（小时）。

## 🎮 指令说明

### 用户指令

- **`stock [interval]`**
  - 查看股市行情。
  - 参数 `interval`: 可选 `day` (日线)、`week` (周线)，不填默认为实时走势（最近100条）。
  - 示例：`stock` (查看实时), `stock day` (查看日线)。

- **`stock.buy <amount>`**
  - 买入股票。
  - 参数 `amount`: 购买股数（整数）。
  - 说明：扣除现金（或银行活期），股票将在冻结时间结束后到账。

- **`stock.sell <amount>`**
  - 卖出股票。
  - 参数 `amount`: 卖出股数（整数）。
  - 说明：扣除持仓，获得的资金将在冻结时间结束后到账。

- **`stock.my`**
  - 查看我的账户。
  - 显示当前持仓、市值以及正在进行中（冻结中）的买卖订单。

### 管理员指令 (权限等级 3)

- **`stock.control <price> [hours]`**
  - 设置宏观调控目标。
  - 说明：强行引导股价在指定时间内向目标价格移动。
  - 示例：`stock.control 5000 12` (在12小时内让股价涨/跌到5000)。

- **`bourse.admin.market <status>`**
  - 设置股市开关状态。
  - 参数 `status`: `open` (开启), `close` (关闭), `auto` (自动)。

## 💡 常见问题

**Q: 为什么买了股票没有立刻到账？**
A: 本插件设计了 T+N 机制（基于金额的动态冻结）。使用 `stock.buy` 后，股票会进入“冻结中”状态，使用 `stock.my` 可以看到剩余解冻时间。卖出股票同理，资金需等待解冻。

**Q: 股价是如何波动的？**
A: 股价由三部分组成：长期趋势（宏观调控决定）、随机波动（模拟市场噪音）和正弦波浪（模拟周期性涨跌）。
